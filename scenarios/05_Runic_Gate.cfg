#textdomain wesnoth-ah

[scenario]
    id=05_Runic_Gate
    name= _ "Runic Gate"
    next_scenario=06_Tears_of_the_Heartfangs
    # Insert the content of the file pointed to at this position.
    map_file=05_Runic_Gate.map
    snapshot=no
    {ASHEN_HEARTS_XP_MODIFIER}

    # load the macros at top level
    {./scenario-utils/05_Runic_Gate-utils.cfg}

    {SCENARIO_MUSIC knolls.ogg}

    ##::Story
    {AH_STORY_RUNIC_GATE}

    # Number of turns
    # {TURNS 46 42 40}
    {TURNS 64 60 56}

    # The player wins if all enemy leaders are dead.
    victory_when_enemies_defeated=no

    ##|| Flow Of Time ||##
    {DEFAULT_SCHEDULE}

    ##|| Determine Side Conditions ||##
    ##|| Player Side
    [side]
        {HERKARTH_SIDE}

        shroud=yes

        ##:: Gold and Income
        {GOLD 320 300 280}
        {INCOME 0 0 0}
    [/side]

    ##|| Foe
    [side]
        ##:: Side Info
        side=2
        controller=ai
        {TEAM_NAME:DWARVES}

        ##:: Leader Info
        type=Dwarvish Runemaster
        id=Kulkruldin
        name=_"Kulkruldin"
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
#ifdef EASY
        recruit=Dwarvish Fighter, Dwarvish Runesmith, Dwarvish Thunderer
#else
        recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Runesmith, Dwarvish Thunderer
#endif

        [ai]
            aggression = 0.99
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
            # Lighting rune locations
            [avoid]
                x=31,31,30,37
                y=2,3,21,23
            [/avoid]
        [/ai]

        ##:: Gold and Income
        {GOLD 20 30 40}
        {INCOME 0 1 2}
    [/side]

    [side]
        ##:: Side Info
        side=3
        controller=ai
        {TEAM_NAME:DWARVES}

        ##:: Leader Info
        type=Dwarvish Lord
        id=Krokkendol
        name=_"Krokkendol"
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
#ifdef EASY
        recruit=Dwarvish Fighter, Dwarvish Runesmith, Dwarvish Thunderer
#else
        recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Runesmith, Dwarvish Thunderer
#endif

        [ai]
            aggression=0.99

            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
        [/ai]

        ##:: Gold and Income
        {GOLD 20 30 40}
        {INCOME 0 1 2}
    [/side]

    [side]
        ##:: Side Info
        side=4
        controller=ai
        {TEAM_NAME:ELVES}

        ##:: Leader Info
        type=Elvish Sharpshooter
        id=Ilaindil
        name=_"Ilaindil"
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
#ifdef EASY
        recruit=Elvish Ranger, Elvish Archer, Elvish Fighter, Wose
#else
        recruit=Elvish Ranger, Elvish Archer, Elvish Fighter, Elder Wose
#endif

        [ai]
            [avoid]
                terrain=Uu^*,Uh^*
            [/avoid]
            aggression=0.8

            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
        [/ai]
        ##:: Gold and Income
        {GOLD 100 120 140}
        {INCOME  0  0  0}
    [/side]
    
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 ("Elvish Fighter") ({ON_DIFFICULTY 2 3 3})}

    [side]
        ##:: Side Info
        side=5
        controller=ai
        {TEAM_NAME:MERFOLK}

        ##:: Leader Info
        type=Mermaid Siren
        id=Elysia
        name=_"Elysia"
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
#ifdef EASY
        recruit=Merman Hunter, Merman Fighter, Merman Warrior
#else
        recruit=Merman Netcaster, Merman Fighter, Merman Warrior
#endif

        ##:: Gold and Income
        {GOLD 100 120 140}
        {INCOME 0 0 0}
        [ai]
            aggression=0.70
            caution=0.30
            [avoid]
                [not]
                    terrain=W*
                [/not]
                [and]
                    [not]
                        terrain=*^Vm
                    [/not]
                [/and]
            [/avoid]
        [/ai]
    [/side]

    [side]
        ##:: Side Info
        side=6
        controller=ai
        team_name=monsters
        user_team_name=_"Monsters"
        {FLAG_VARIANT6 ragged}

        ##:: Leader Info
        no_leader=yes

        ##:: Recruit List
        recruit=
        # add an avoid condition
        # to make them steer clear of the land
        # where they have poor defence
        [ai]
            [avoid]
                [not]
                    terrain=W*
                [/not]
                [and]
                    [not]
                        terrain=*^Vm
                    [/not]
                [/and]
            [/avoid]
        [/ai]
    [/side]

    [event]
        name=prestart

        {ASHEN_HEART_RECALL_COSTS_ADJUSTMENT}

        ##:: Capture the forest villages
        {CAPTURE_VILLAGES 3 31 8 15 }

        {PLACE_IMAGE scenery/dwarven-doors-closed.png 39 6}

        {LOYAL_UNIT 2 (Dwarvish Protector) 31 21}
        {LOYAL_UNIT 2 (Dwarvish Protector) 37 22}

        {LOYAL_UNIT 2 (Dwarvish Runesmith) 31 20}
        {LOYAL_UNIT 2 (Dwarvish Runesmith) 36 21}

        {LOYAL_UNIT 2 (Dwarvish Protector) 32 2}
        {LOYAL_UNIT 2 (Dwarvish Protector) 32 3}
        {LOYAL_UNIT 2 (Dwarvish Runemaster) 33 3}

        {LOYAL_UNIT 4 (Elvish Ranger) 34 35}
        {LOYAL_UNIT 4 (Elvish Ranger) 36 34}

        {LOYAL_UNIT 5 (Mermaid Priestess) 9 10}
        {LOYAL_UNIT 5 (Merman Spearman) 9 9}

        {GENERIC_UNIT 2 (Dwarvish Protector) 22 14}
        {GENERIC_UNIT 2 (Dwarvish Protector) 21 14}
        {GENERIC_UNIT 2 (Dwarvish Protector) 24 15}
        {GENERIC_UNIT 2 (Dwarvish Protector) 25 16}

        {GENERIC_UNIT 2 (Dwarvish Runesmith) 22 13}
        {GENERIC_UNIT 2 (Dwarvish Protector) 23 14}
        {GENERIC_UNIT 2 (Dwarvish Protector) 25 15}
        {GENERIC_UNIT 2 (Dwarvish Runesmith) 26 15}

        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 24 13}
        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 23 13}
        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 26 14}
        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 27 15}

        {LOYAL_UNIT 2 (Bear Cavalry) 27 13}

        # Units at gates
        [modify_unit]
            [filter]
                x=21-27
                y=10-16
                side=2
            [/filter]
            [status]
                guardian=yes
            [/status]
            facing=sw
        [/modify_unit]

        {PLACE_RUNIC_MINE 30 21}
        {PLACE_RUNIC_MINE 37 23}

        {PLACE_RUNIC_MINE 31 2}
        {PLACE_RUNIC_MINE 31 3}

        [time_area]
            x=13-46,26-46,11-20
            y=0-17,18-28,29-36
            {UNDERGROUND}
        [/time_area]

        ##::dwarvish guardians defend bottlenecks

        # Defense north entrance
        [micro_ai]
            side=2
            ai_type=bottleneck_defense
            action=add
            ca_score=100000
            [filter]
                x=32,32,33
                y=2,3,3
            [/filter]
            x=32,32
            y=2,3
            enemy_x=31,31
            enemy_y=2,3
        [/micro_ai]

        # Defense south entrance
        [micro_ai]
            side=2
            ai_type=bottleneck_defense
            action=add
            ca_score=100000
            [filter]
                x=31,31
                y=21,20
            [/filter]
            x=31
            y=21
            enemy_x=30
            enemy_y=21
        [/micro_ai]

        # Defense south east entrance
        [micro_ai]
            side=2
            ai_type=bottleneck_defense
            action=add
            ca_score=100000
            [filter]
                x=37,36
                y=22,21
            [/filter]
            x=37
            y=22
            enemy_x=37
            enemy_y=23
        [/micro_ai]

        # Disabled this micro ai. It seemed to overwrite the previous one causing lag
        #[micro_ai]
        #    side=2
        #    ai_type=goto
        #    action=add
        #		ca_score=120000

        #    [filter]
        #        type=Dwarvish Protector, Dwarvish Runesmith, Dwarvish Runemaster
        #    [/filter]
        #    [filter_location]
        #        [filter]
        #        [/filter]
        #        [not]
        #            [filter]
        #                side=1
        #            [/filter]
        #            radius=0
        #        [/not]
        #    [/filter_location]
        #[/micro_ai]

        ##::Elvish Rangers and Woses
        [micro_ai]
            side=4
            ai_type=lurkers
            action=add

            [filter]
                type=Elvish Ranger, Elder Wose, Wose
            [/filter]
            [filter_location]
                terrain=*^F*
            [/filter_location]
            [filter_location_wander]
                terrain=*^F*
            [/filter_location_wander]
        [/micro_ai]

        [micro_ai]
            side=3
            ai_type=zone_guardian
            action=add
            ca_score=170000
            [filter]
                side=3
                [not]
                    id=Krokkendol
                [/not]
            [/filter]
            [filter_location]
                x=15-31,20-46,31-46
                y=2-11,12-16,17-22
                terrain=R*^*,U*^*,C*^*,K*^*
            [/filter_location]
        [/micro_ai]

        {GENERIC_UNIT 6 (Sea Serpent) 20 20}

        [micro_ai]
            side=6
            ai_type=return_guardian
            action=add

            [filter]
                type=Sea Serpent
            [/filter]
            return_x,return_y=20,20
        [/micro_ai]

        [set_variables]
            name=glyphs

            [value]
                x,y=10,9
                image_off=scenery/rune1.png
                image_on=scenery/rune1-glow.png
            [/value]
            [value]
                x,y=35,35
                image_off=scenery/rune2.png
                image_on=scenery/rune2-glow.png
            [/value]
        [/set_variables]

        [foreach]
            array=glyphs
            [do]
                [item]
                    x,y=$this_item.x,$this_item.y
                    image=$this_item.image_on
                [/item]
            [/do]
        [/foreach]

        [unit]
            side=1
            {AH_CHARACTER_STATS:ULUTHUR}
            placement=leader
        [/unit]
    [/event]

    [event]
        name=start

        [message]
            speaker=Herkarth
            message= _ "Here it is, the temple of our ancestors! It is indeed sealed, but not by the sorcery of our forefathers. Something else blocks the entrance."
        [/message]

        # move Herkarth to his keep
        {MOVE_UNIT (id="Herkarth") 3 32}

        [if]
            [have_unit]
                id=Elri
                search_recall_list=yes
            [/have_unit]
            [then]
                [recall]
                    id=Elri
                [/recall]

                [message]
                    speaker=Elri
                    message= _ "I sense the presence of the traitor. Help me find him, so that I may end his life."
                [/message]

                ##:: Objectives
                {AH_RUNIC_OBJECTIVE (
                    [objective]
                        caption= _ "Optional Objective"
                        description= _ "Elri finds the traitor and kills him"
                        condition=win
                    [/objective]
                )}
            [/then]
            [else]
                ##:: Objectives
                {AH_RUNIC_OBJECTIVE ()}
            [/else]
        [/if]
    [/event]

    [event]
        name=sighted
        first_time_only=yes

        [filter]
            race=merman
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "In the name of Naia, the drakes are approaching! We must not let them enter the temple, lest they awaken the one inside! Hold them back!"
        [/message]
    [/event]

    [event]
        name=sighted
        first_time_only=yes

        [filter]
            race=elf
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "By Wesmere, the drakes return! May the sylphs guide our arrows into the ashen hearts of these beasts! Slay them all!"
        [/message]

        [if]
            [have_unit]
                id=Elri
                search_recall_list=yes
            [/have_unit]
            [then]
                [message]
                    speaker=Elri
                    message= _ "These must be the traitor's followers."
                [/message]

                [message]
                    speaker=Herkarth
                    message= _ "They seek to attack and bar our path to the temple. And they are of your kind. Are you sure we can trust you, elf?"
                [/message]

                [message]
                    speaker=Elri
                    message= _ "Your temple is not of concern to us elves. I have already told you, my goal is to hunt a traitor who has violated our laws and disobeyed the orders of our elders. I seek to make him pay in blood, no less, no more. It is not my task, nor my place to interfere with the matter of your temple."
                [/message]

                [message]
                    speaker=Elri
                    message= _ "Ilaindil is the traitor's name. Let me find him and claim the debt of blood that he owes the Lintair elves. You may do whatever you must after."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=sighted
        first_time_only=yes

        [filter]
            race=dwarf
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "Kulkruldin, tha drakes be here! We need reinforcements! Dwarves, fortify tha walls! Shields high!"
        [/message]

        [message]
            speaker=Herkarth
            message= _ "Those pesky stoneheads have fortified the walls and the spear-wielding ones defend them with their shields. Perhaps our <b>enforcers and thrasher</b> can break through, or perhaps we can find another way around."
        [/message]
    [/event]

    [event]
        name=die
        first_time_only=yes
        [filter]
            type=Dwarvish Protector
        [/filter]

        [message]
            speaker=Herkarth
            message= _ "These stoneheads are very resilient. Their runic magic must be reinforcing their shields. We will need something with more impact to break through them."
        [/message]
    [/event]

    ##:: smashing the weak cave wall events
    # event: indicate to players 
    [event]
        name=enter_hex
        first_time_only=yes
        [filter]
            side=1
            x,y=8-13,6-11
        [/filter]

        [message]
            speaker=unit
            message= _ "Look there, those walls are less durable! Our thrashers or enforcers can probably break through them with their rams!"
        [/message]

        {AH_FLASH_TILE 14 7 misc/green-flash-border.png ()}
        {AH_FLASH_TILE 15 11 misc/green-flash-border.png ()}
    [/event]

    # event: wall break event
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=14,7
            type=Drake Thrasher, Drake Enforcer
        [/filter]

        [repeat]
            times=3
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    hits=yes

                    [primary_attack]
                        type=impact
                    [/primary_attack]

                    [facing]
                        x,y=15,7
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        {EARTHQUAKE ()}
        [terrain]
            x,y=15,7
            terrain=Uh
        [/terrain]
        [redraw]
        [/redraw]
    [/event]

    # event: wall break event
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=15,11
            type=Drake Thrasher, Drake Enforcer
        [/filter]

        [repeat]
            times=3
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    hits=yes

                    [primary_attack]
                        type=impact
                    [/primary_attack]

                    [facing]
                        x,y=16,10
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        {EARTHQUAKE ()}
        [terrain]
            x,y=16,10
            terrain=Uh
        [/terrain]
        [redraw]
        [/redraw]
    [/event]

    ##:: found the short cut to the temple entrance
    [event]
        name="enter_hex"
        first_time_only=yes

        [filter]
            side=1
            x=38,37,38
            y=10,11,11
        [/filter]

        [message]
            speaker=unit
            canrecruit=no
            message= _ "Look! The cave wall here is weak! Our thrashers or enforcers can probably break through them with their rams!"
        [/message]

        {AH_FLASH_TILE 38 10 misc/green-flash-border.png ()}

        # we indicate that the short cut is here
        [message]
            speaker="Herkarth"
            message=_"What an advantageous location! We can probably sneak in to the temple through here!"
        [/message]

        [message]
            speaker="Uluthur"
            message=_"An amazing find, indeed!"
        [/message]
    [/event]

    # event: wall break event
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=38,10
            type=Drake Thrasher, Drake Enforcer
        [/filter]

        [repeat]
            times=3
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    hits=yes

                    [primary_attack]
                        type=impact
                    [/primary_attack]

                    [facing]
                        x,y=39,10
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        {EARTHQUAKE ()}
        [terrain]
            x,y=39,10
            terrain=Uh
        [/terrain]
        [redraw]
        [/redraw]
    [/event]

    ##:: event: Elri kills the traitor
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            id=Ilaindil
        [/filter]

        [filter_second]
            id=Elri
        [/filter_second]

        [message]
            speaker=Ilaindil
            message= _ "Ah... a bloodmaiden... they sent you... to find me?"
        [/message]

        [message]
            speaker=Elri
            message= _ "The elders did, Ilaindil. Your blood is demanded as payment for your crimes."
        [/message]

        [message]
            speaker=Ilaindil
            message= _ "What... have I done... to deserve this?"
        [/message]

        [message]
            speaker=Elri
            message= _ "You know what you have done, traitor to the elves of Lintanir. Your end shall be here."
        [/message]

        {VARIABLE sword_x $x1}
        {VARIABLE sword_y $y1}
    [/event]

    ##:: event: Elri kills the traitor, and he dies
    [event]
        name=die
        first_time_only=yes
        [filter]
            id=Ilaindil
        [/filter]

        [filter_second]
            id=Elri
        [/filter_second]

        [message]
            speaker=Elri
            message= _ "I have completed my task and must return to Lintair forest to report my success to the elders. Our paths part here."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "It was an honour to fight at your side."
        [/message]

        [message]
            speaker=Elri
            message= _ "Drakes, you aided me in my duty. As a token of appreciation, take my amulet."
        [/message]

        {AH_WISH_ITEM_AMULET_ELRI $sword_x $sword_y}

        [redraw]
        [/redraw]

        [message]
            speaker=Elri
            message= _ "Farewell."
        [/message]

        {MOVE_UNIT (id=Elri) 40 36}

        [kill]
            id=Elri
        [/kill]
        {AH_RUNIC_OBJECTIVE ()}
    [/event]

    ##:: event: the traitor is killed
    # but not by Elri
    [event]
        name=die
        first_time_only=yes
        [filter]
            id=Ilaindil
        [/filter]

        [filter_second]
            [not]
                id=Elri
            [/not]
        [/filter_second]

        [if]
            [have_unit]
                id=Elri
            [/have_unit]
            [then]
                [message]
                    speaker=Elri
                    message= _ "No! You killed him! The blood price placed on Ilaindil's head was for my blade, and my blade only. By taking my quarry from me, you have taken his mark upon yourselves. Now your blood will dye the rivers red!"
                [/message]

                [modify_unit]
                    [filter]
                        id=Elri
                    [/filter]
                    side=4
                [/modify_unit]
            [/then]
            [else]
            [/else]
        [/if]
        {AH_RUNIC_OBJECTIVE ()}
    [/event]

    ##:: Herkarth moves to the entrance
    [event]
        name=moveto
        [filter]
            id=Herkarth
            x,y=39,6
        [/filter]

        [message]
            speaker=Herkarth
            message= _ "This is the entrance, let's go!"
        [/message]

        [if]
            [have_unit]
                id=Elri
                search_recall_list=yes
            [/have_unit]
            [then]
                [recall]
                    id=Elri
                [/recall]

                [message]
                    speaker=Elri
                    message= _ "I can not join you. Ilaindil won't be inside the temple. I must seek him elsewhere."
                [/message]

                {MOVE_UNIT (id=Elri) 40 36}

                [kill]
                    id=Elri
                [/kill]

                [message]
                    speaker=Uluthur
                    message= _ "Hmmph."
                [/message]
            [/then]
        [/if]

        # add achievement
        {ASHEN_HEARTS_ACHIEVEMENT_SCENARIO 05_Runic_Gate}

        [endlevel]
            result=victory
            carryover_percentage=10
            carryover_add=yes
        [/endlevel]
    [/event]

    {AH_DEATHS:HERKARTH}
    {AH_DEATHS:ULUTHUR}

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                find_in=glyphs
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=gate_closed
                boolean_equals=no
            [/variable]
        [/filter_condition]

        {GLYPH_ON $x1 $y1}

        [if]
            [have_unit]
                side=1

                [filter_location]
                    find_in=glyphs
                [/filter_location]

                count=2
            [/have_unit]

            [then]
                {VARIABLE gate_closed yes}

                [message]
                    speaker=Herkarth
                    message= _ "Aha! These runes have the ability to open the gates!"
                [/message]

                [scroll_to]
                    x,y=22,15
                [/scroll_to]

                [sound]
                    name=rumble.ogg
                [/sound]

                [delay]
                    time=1500
                [/delay]

                [terrain]
                    x=21,22,23
                    y=15,15,16
                    layer=overlay
                    terrain="^"
                [/terrain]

                [redraw][/redraw]

                [delay]
                    time=2000
                [/delay]

                [message]
                    speaker=Herkarth
                    message= _ "Now we can enter the fortress! Forward!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "This rune looks like it has something to do with the gates."
                [/message]

                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    # Toggles a glyph off when the player steps off it
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                [not]
                    find_in=glyphs
                [/not]
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=gate_closed
                boolean_equals=no
            [/variable]

            [have_location]
                x,y=$x2,$y2
                find_in=glyphs
            [/have_location]
        [/filter_condition]

        {GLYPH_OFF $x2 $y2}
    [/event]

    # Toggles a glyph off when the player unit on it dies
    [event]
        name=die
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                find_in=glyphs
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=gate_closed
                boolean_equals=no
            [/variable]
        [/filter_condition]

        {GLYPH_OFF $x1 $y1}
    [/event]

    # event: scenario end
    [event]
        name=scenario_end

        {CLEAR_VARIABLE glyphs,glyph_i,locations_outside,gate_closed}
    [/event]

    # add runic gate graphics as a macro
    # these are from SoF
    {RUNIC_GATE_TERRAIN_GRAPHICS}

    {UX_HIGHLIGHT_MISSES_EVENT}
[/scenario]
